pipeline{
    agent any //defining agent

    stages{
	
	    stage('app-code'){
            steps{
                
                dir('app-code') {
                     git url: "https://github.com/Aniket-d-d/TWSThreeTierAppChallenge.git", branch: "ak-automate" //clone-the app-code
                }
            }
        }
        
		stage('Build Images'){
            steps{
			
			     dir('app-code/frontend') {
				 sh "docker build -t three-tier-frontend:latest ."
				 echo "Frontend Image Built Successfully"
				}

				 dir('app-code/backend') {
				 sh "docker build -t three-tier-backend:latest ."
				 echo "Backend Image Built Successfully"
				}
            }
            
        }
		
		stage('Push Images'){

		    environment {
                AWS_CREDS = credentials('aws-cli-cred')   //docker-credentials
            }
            steps{
                 dir('app-code'){
				 sh "chmod +x update_variables.sh"
				 sh "./update_variables.sh"
                 sh "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/ALIAS_INFO"
				 sh "docker tag three-tier-frontend:latest public.ecr.aws/ALIAS_INFO/three-tier-frontend:latest"
				 sh "docker push public.ecr.aws/ALIAS_INFO/three-tier-frontend:latest"
				 echo "Frontend Image Pushed Successfully"
				 
				 sh "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/ALIAS_INFO"
				 sh "docker tag three-tier-backend:latest public.ecr.aws/ALIAS_INFO/three-tier-backend:latest"
				 sh "docker push public.ecr.aws/ALIAS_INFO/three-tier-backend:latest"
				 echo "Backend Image Pushed Successfully"
			}
        }
        
   	 }
	}
}